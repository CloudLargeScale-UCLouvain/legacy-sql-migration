# Migration-tenant

## What is this

migration-tenant permits to generate a split database installation, and to migrate a tenant from an origin database to a destination database.

## Installation
The tool is made in Python 3. We assume a running installation is available. Dependencies ([Postgresql](https://www.postgresql.org/) and [Pyrseas](https://github.com/perseas/Pyrseas)) should be installed as well:
```
apt install postgresql-client libpq-dev postgresql-common
pip3 install psycopg2-binary Pyrseas
```

## Usage
We assume the presence of three configurations files:
- `db.yaml`: contains the structure of the database as a YAML file. This one should be generated by Pyrseas.
- `infra.yaml`: contains the parameters (host, credentials, ...) of the databases
- `config.yaml`: general configuration, and specification of the tenant table (the one containing the tenant), its needed identifiers, and the list of the tenant tables and their subqueries.

Please refer to the Camunda and Iomad samples, and the source code for reference.

The following commands can be launched with migrate-tenant:
- `--init` / `-i`: generates a split database structure (tenant, reference) on all parametered databases, based on the infrastructure file (`infra.yaml`), the initial database structure file (`db.yaml`) and the configuration file (`config.yaml`). 
- `--migrate` / `-m`: launch the migration of a tenant with a given identifier from an origin to a destination database.
- `--describe` / `-d`: describes the current state of the database (list of databases and which tenant is on which database)
- `--export` / `-e`: exports the list of the reference and database tables to a YAML file

### How to start?

Start an empty target system. Expose/port-forward your database part. Extract the schema using Pyrseas, for example with Camunda :
```
dbtoyaml -H localhost -U camunda -W process-engine > db.yaml
```

Dump raw database data (the initial data needed for the start of the application). Isolate sequences.
```
export PGPASSWORD="camunda"
pg_dump --column-inserts --data-only --disable-triggers -h localhost -U camunda process-engine >dump_data.sql
cat dump_data.sql |grep setval > sequence.sql
```

Prepare the configuration files: `infra.yaml` should point on the databases (tenant databases, and reference). `config.yaml` should target the good files, and precise the wanted tenant table, tenant database tables, and their subqueries. As an example, you can find below the Camunda `config.yaml` file:
```yaml
metadata:
  infra_file: infra-intern.yaml
  database_schema_file: db.yaml
  psql: true
  tenant:
    table: act_id_tenant
    identifier: id_
    label: name_
    describe_resource_query: "select distinct t.id_ as id, t.name_ as name from act_id_tenant t join act_id_tenant_member tm on t.id_ = tm.tenant_id_"
    tenant_dynamic_tables:
      - tenant:
          tableName: "*"
          except: ['act_ge_bytearray', 'act_re_deployment']
          fields: ['tenant_id_']
          subquery: ":field IN (':tenantId')"
```          

In this case, the table containing the tenants is `act_id_tenant`, the identifier of tenants is in the field `_id`, and its label `name_`. The `describe_resource_query` field contains a SQL query permitting to get the list of the tenants, used for feedback and internal processing. 
Field `tenant_dynamic_tables` contains the list of the tables that will be put in the tennant database. In this case, every table containing the `tenant_id_` field, except `act_ge_bytearray` and `act_re_deployment`. The `subquery` will be used for migration operations, using the `identifier` and the passed tenant identifier.

Once everything is ready, execute the initialization command to generate the structure on all databases.
```
python migrate.py -i
```

Once the structure is set, you should source the minimal data for the application, here an example with two tenant databases: 
```
# origin database
psql -h localhost -U camunda -p 5432 camunda < dump_data.sql
# target database
psql -h localhost -U camunda -p 5434 camunda < dump_data.sql
# reference database
psql -h localhost -U camunda -p 5433 camunda < sequence.sql
```

The system is running. You can connect webservers to the tenant databases. To migrate a tenant with the _tenantid_ identifier, from the tenant database _db1_ to _db2_ you can launch the following commands:
```
python migrate.py --describe # the tenant is on db1
python migrate.py --migrate=tenantid,db1,db2
python migrate.py --describe # the tenant should be on db2.

```